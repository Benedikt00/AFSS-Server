{% macro render_categories_table(categorys) %}

<div id="category_table">

<table>
    <thead>
        <th>Name</th>
        <th>Unit</th>
        <th>Prefixes</th>
        <th><button onclick="new_cat()" id="add_button">+</button></th>
    </thead>
    <tbody id="category_table_body">
    {% for Category in categorys %}
    <tr>
        <td ondblclick="to_input(this, 50, '{{ Category.title }}', 'title')">{{Category.title}}</td>
        <td ondblclick="to_input(this, 10, '{{ Category.title }}', 'unit')">{{Category.unit}}</td>
        <td ondblclick="to_input(this, 100, '{{ Category.title }}', 'prefixes')" >{{Category.prefixes}}</td>
        <td><button onclick="delete_cat('{{Category.title}}')">del</button></td>
    </tr>
    {% endfor %}
    </tbody>
    
</table>
<button onClick="submit_changes()">Submit Changes</button>
<div id="message">
        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <ul>
            {% for message in messages %}
            <li>{{ message }}</li>
            {% endfor %}
        </ul>
        {% endif %}
        {% endwith %}
    </div>
</div>
<script>

    var activeInput = null; // Variable to keep track of active input

    var activeInput = null
    var activeId = null
    var activeCategory = null

    var changes = []

    function new_cat() {
        var newRow = document.createElement('tr');
        newRow.innerHTML = `
        <td><input type="text" name="title"></td>
        <td><input type="text" name="unit"></td>
        <td><input type="text" name="prefixes"></td>
        <td><button onclick="saveNewCategory(this)">Save</button></td>
    `;
        document.getElementById('category_table_body').insertBefore(newRow, document.getElementById('category_table_body').firstChild);
    
        document.getElementById("add_button").hidden = true;
    }

    function submit_changes() {
        sendData({ "changes": changes }, set_cats)
    }

    function delete_cat(id){
        console.log("del")
        sendData({"delete": id}, set_cats)
    }

    function saveNewCategory(button) {

        var newRow = button.parentNode.parentNode;

        var title = newRow.querySelector('input[name="title"]').value;
        var unit = newRow.querySelector('input[name="unit"]').value;
        var prefixes = newRow.querySelector('input[name="prefixes"]').value;

    sendData({"new_cat": {"title": title, "unit": unit, "prefixes": prefixes}}, set_cats)

        newRow.parentNode.removeChild(newRow);
        document.getElementById("add_button").hidden = false;

    }

    function set_cats(response) {
        document.getElementById('category_table').innerHTML = response
    }

    function sendData(data, callback) {
        var xhr = new XMLHttpRequest();
        var url = "{{url_for('manage_db.edit_categories_db')}}";

        xhr.open("POST", url, true);
        xhr.setRequestHeader("Content-Type", "application/json");

        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
                // Request was successful, handle response here if needed
                //console.log(xhr.responseText);
                callback(xhr.responseText)  // 2/2 statdessen braucht man eine callback funkltion und muss das so klobig machen


            }
        };

        var jsonData = JSON.stringify(data);
        xhr.send(jsonData);
    }

    function to_input(el, max_len, id, categorie) {
        // Check if there's an active input, close it if exists
        if (activeInput !== null) {
            close_input(activeInput);
        }
        console.log(el)

        var val = el.innerHTML.trim(); // Trim whitespace
        var inputHTML = "<input class=\"search_input\" type=\"text\" value=\"" + val + "\" maxlen=\"" + max_len + "\"/>";
        el.innerHTML = inputHTML;
        console.log(val)
        // Set the active input to this one
        activeInput = el;
        activeId = id
        activeCategory = categorie
        // Focus on the input field
        el.querySelector('input').focus();
    }

    // Function to close the input and restore the original content
    function close_input(el) {
        var inputValue = el.querySelector('input').value; // Get the input value
        el.innerHTML = inputValue; // Restore original content

        //console.log(activeCategory)
        new_ch = { [activeId]: { [activeCategory]: inputValue } } // [] um die variable ALS KEY VERWENDEN ZU KÃ–NNEN

        changes.push(new_ch)
        activeInput = null; // Reset active input
        activeId = null
        activeCategory = null
    }

    // Function to handle double click on table cell
    function onDoubleClickHandler(el) {
        if (el.tagName.toLowerCase() === 'td') {
            to_input(el);
        }
    }

    // Function to handle clicking outside input
    document.addEventListener('click', function (event) {
        if (activeInput !== null && !activeInput.contains(event.target)) {
            close_input(activeInput);
        }
    });

    // Function to handle pressing Enter key
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Enter' && activeInput !== null) {
            close_input(activeInput);
        }
    });

</script>


{% endmacro %}